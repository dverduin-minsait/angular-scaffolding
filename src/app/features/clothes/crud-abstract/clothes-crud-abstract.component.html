<div class="crud-container">
  <h2 id="crud-title">Clothes Manager</h2>

  <section class="status-bar" aria-labelledby="crud-title">
    <div class="status-item" [class.loading]="clothesService.loading().isLoading">
      <span aria-live="polite">{{ clothesService.loading().isLoading ? 'Loading ' + clothesService.loading().operation : 'Ready' }}</span>
    </div>
    <div class="status-item" aria-label="Items loaded">Items: {{ clothesService.items().length }}</div>
    <div class="status-item" *ngIf="clothesService.error()" role="alert" aria-live="assertive">
      ⚠️ {{ clothesService.error()?.message }}
    </div>
  </section>

  <section class="grid-section" aria-label="Items list">
    <div class="grid-actions">
  <button type="button" appButton variant="secondary" (click)="refreshData()" [disabled]="clothesService.loading().isLoading">Refresh</button>
  <button type="button" appButton variant="secondary" (click)="clearSelection()" [disabled]="!selectedItem()">Clear Selection</button>
  <button type="button" appButton variant="secondary" (click)="openTestModal()">Open Test Modal</button>
      <details class="column-toggle-panel">
        <summary>Columns</summary>
        <div class="columns-list">
          <ng-container *ngFor="let col of columnKeys; trackBy: trackByFn">
            <label class="col-toggle">
              <input type="checkbox" [checked]="columnVisibility()[col]" (change)="toggleColumn(col)" />
              <span>{{ col }}</span>
            </label>
          </ng-container>
        </div>
      </details>
    </div>
    <app-responsive-grid 
      [dataConfig]="dataConfig"
      [dataSignal]="clothesService.items()"
      [config]="gridConfig">
      <div slot="mobile-cards" class="mobile-cards">
        @for (item of clothesService.items(); track item.id) {
          <div class="mobile-card" (click)="editItem(item)" tabindex="0" (keydown.enter)="editItem(item)" (keydown.space)="editItem(item)">
            <header class="card-header"><h3>{{ item.name }}</h3><span class="brand">{{ item.brand }}</span></header>
            <div class="card-body">
              <div class="row"><strong>Price:</strong> {{ item.price | miniCurrency }}</div>
              <div class="row"><strong>Stock:</strong> <span [class.low-stock]="item.stock<=5">{{ item.stock }}</span></div>
              <div class="row"><strong>Category:</strong> {{ item.category || '—' }}</div>
              <div class="row"><strong>Season:</strong> {{ item.season || '—' }}</div>
            </div>
          </div>
        }
      </div>
    </app-responsive-grid>
  </section>

  <section class="form-section" aria-labelledby="form-title">
    <h3 id="form-title">{{ isEditing() ? 'Edit Item' : 'Add New Item' }}</h3>
    <form class="auth-form" [formGroup]="itemForm" (ngSubmit)="onSubmit()" novalidate>
      <fieldset class="form-group form-group-inline">
        <legend class="visually-hidden">Basic Info</legend>
        <div>
          <label for="name">Name <span aria-hidden="true">*</span></label>
          <input id="name" class="form-control" type="text" formControlName="name" required aria-required="true" [attr.aria-invalid]="nameError()? 'true':'false'" [attr.aria-describedby]="nameError()? 'name-error': null" />
          @if(nameError()){<div id="name-error" class="error-message" role="alert">{{ nameError() }}</div>}
        </div>
        <div>
            <label for="brand">Brand <span aria-hidden="true">*</span></label>
            <input id="brand" class="form-control" type="text" formControlName="brand" required aria-required="true" [attr.aria-invalid]="brandError()? 'true':'false'" [attr.aria-describedby]="brandError()? 'brand-error': null" />
            @if(brandError()){<div id="brand-error" class="error-message" role="alert">{{ brandError() }}</div>}
        </div>
      </fieldset>

      <div class="form-group">
        <label for="price">Price <span aria-hidden="true">*</span></label>
  <input id="price" class="form-control" type="number" step="0.01" formControlName="price" required aria-required="true" [attr.aria-invalid]="priceError()? 'true':'false'" [attr.aria-describedby]="priceError()? 'price-error': null" />
        @if(priceError()){<div id="price-error" class="error-message" role="alert">{{ priceError() }}</div>}
      </div>

      <div class="form-group">
        <label for="stock">Stock <span aria-hidden="true">*</span></label>
  <input id="stock" class="form-control" type="number" formControlName="stock" required aria-required="true" [attr.aria-invalid]="stockError()? 'true':'false'" [attr.aria-describedby]="stockError()? 'stock-error': null" />
        @if(stockError()){<div id="stock-error" class="error-message" role="alert">{{ stockError() }}</div>}
      </div>

      <div class="form-group-inline">
        <div>
          <label for="size">Size</label>
          <select id="size" class="form-control" formControlName="size">
            <option value="">Select size</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
          </select>
        </div>
        <div>
          <label for="season">Season</label>
          <select id="season" class="form-control" formControlName="season">
            <option value="">Select season</option>
            <option value="Spring">Spring</option>
            <option value="Summer">Summer</option>
            <option value="Fall">Fall</option>
            <option value="Winter">Winter</option>
          </select>
        </div>
      </div>

      <div class="form-group-inline">
        <div>
          <label for="category">Category</label>
          <input id="category" class="form-control" type="text" formControlName="category" />
        </div>
        <div>
          <label for="color">Color</label>
          <input id="color" class="form-control" type="text" formControlName="color" />
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
  <textarea id="description" class="form-control" formControlName="description" rows="3" placeholder="Optional description"></textarea>
      </div>

      <div class="form-actions">
  <button type="submit" appButton variant="primary" [disabled]="itemForm.invalid || clothesService.loading().isLoading">{{ isEditing()? 'Update Item' : 'Create Item' }}</button>
  <button type="button" appButton variant="secondary" (click)="resetForm()">Reset</button>
  @if(isEditing()){<button type="button" appButton variant="secondary" (click)="cancelEdit()">Cancel</button>}
      </div>
    </form>
  </section>

  <section class="stats-section" aria-label="Statistics">
    <div class="stats-grid">
      <div class="stat-card" aria-label="Total items"><span class="stat-label">Total</span><span class="stat-value">{{ clothesService.items().length }}</span></div>
      <div class="stat-card" aria-label="Available items"><span class="stat-label">Available</span><span class="stat-value">{{ clothesService.availableItems().length }}</span></div>
      <div class="stat-card" aria-label="Low stock items"><span class="stat-label">Low Stock</span><span class="stat-value">{{ clothesService.lowStockItems().length }}</span></div>
      <div class="stat-card" aria-label="Inventory value"><span class="stat-label">Value</span><span class="stat-value">${{ clothesService.totalValue().toFixed(2) }}</span></div>
    </div>
  </section>
</div>