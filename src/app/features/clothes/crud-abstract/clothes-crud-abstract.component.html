<div class="crud-container">
  <h2 id="crud-title">{{ 'app.clothes.crud.title' | translate }}</h2>

  <section class="status-bar" aria-labelledby="crud-title">
    <div class="status-item" [class.loading]="clothesStore.loading().isLoading">
      <span aria-live="polite">
        {{ clothesStore.loading().isLoading ? (('app.clothes.crud.loading' | translate) + ' ' +
        clothesStore.loading().operation) : ('app.clothes.crud.ready' | translate) }}
      </span>
    </div>
    <div class="status-item" aria-label="{{ 'app.clothes.crud.itemsLoaded.aria' | translate }}">{{
      'app.clothes.crud.items' | translate }}: {{ clothesStore.items().length }}</div>
      @if(clothesStore.error()) {
        <div class="status-item" role="alert" aria-live="assertive">
          ⚠️ {{ clothesStore.error()?.message }}
        </div>
      }
  </section>

  <section class="grid-section" aria-label="Items list">
    <div class="grid-actions">
      <button type="button" appButton variant="secondary" (click)="refreshData()"
        [disabled]="clothesStore.loading().isLoading">
        {{ 'app.clothes.crud.actions.refresh' | translate }}
      </button>
      <button type="button" appButton variant="secondary" (click)="clearSelection()" [disabled]="!selectedItem()">
        {{ 'app.clothes.crud.actions.clearSelection' | translate }}
      </button>
      <button type="button" appButton variant="secondary" (click)="openTestModal()">{{
        'app.clothes.crud.actions.openTestModal' | translate }}</button>
      <details class="column-toggle-panel">
        <summary>{{ 'app.clothes.crud.columnsPanelTitle' | translate }}</summary>
        <div class="columns-list">
          @for (col of columnKeys; track $index) {
            <label class="col-toggle">
              <input type="checkbox" [checked]="columnVisibility()[col]" (change)="toggleColumn(col)" />
              <span>{{ ('app.clothes.catalog.columns.' + col) | translate }}</span>
            </label>
          }
        </div>
      </details>
    </div>
    <app-responsive-grid [dataConfig]="dataConfig" [dataSignal]="clothesStore.items()" [config]="gridConfig()">
      <div slot="mobile-cards" class="mobile-cards">
        @for (item of clothesStore.items(); track item.id) {
        <div class="mobile-card" (click)="editItem(item)" tabindex="0" (keydown.enter)="editItem(item)"
          (keydown.space)="editItem(item)">
          <header class="card-header">
            <h3>{{ item.name }}</h3><span class="brand">{{ item.brand }}</span>
          </header>
          <div class="card-body">
            <div class="row"><strong>Price:</strong> {{ item.price | miniCurrency }}</div>
            <div class="row"><strong>Stock:</strong> <span [class.low-stock]="item.stock<=5">{{ item.stock }}</span>
            </div>
            <div class="row"><strong>Category:</strong> {{ item.category || '—' }}</div>
            <div class="row"><strong>Season:</strong> {{ item.season || '—' }}</div>
          </div>
        </div>
        }
      </div>
    </app-responsive-grid>
  </section>

  <section class="form-section" aria-labelledby="form-title">
    <h3 id="form-title">{{ isEditing() ? ('app.clothes.crud.form.editTitle' | translate) :
      ('app.clothes.crud.form.addTitle' | translate) }}</h3>
    <form class="crud-form" [formGroup]="itemForm" (ngSubmit)="onSubmit()" novalidate>
      <fieldset class="field-grid">
        <legend class="visually-hidden">{{ 'app.clothes.crud.form.basicInfo' | translate }}</legend>
        <div class="form-field">
          <label class="form-label" for="name">{{ 'app.clothes.crud.form.fields.name.label' | translate }} <span
              aria-hidden="true">*</span></label>
          <input id="name" class="form-control" type="text" formControlName="name" required aria-required="true"
            [attr.aria-invalid]="nameError()? 'true':'false'"
            [attr.aria-describedby]="nameError()? 'name-error': null" />
          @if(nameError()){<div id="name-error" class="form-error" role="alert">{{ nameError() }}</div>}
        </div>
        <div class="form-field">
          <label class="form-label" for="brand">{{ 'app.clothes.crud.form.fields.brand.label' | translate }} <span
              aria-hidden="true">*</span></label>
          <input id="brand" class="form-control" type="text" formControlName="brand" required aria-required="true"
            [attr.aria-invalid]="brandError()? 'true':'false'"
            [attr.aria-describedby]="brandError()? 'brand-error': null" />
          @if(brandError()){<div id="brand-error" class="form-error" role="alert">{{ brandError() }}</div>}
        </div>
      </fieldset>
      <div class="form-field">
        <label class="form-label" for="price">{{ 'app.clothes.crud.form.fields.price.label' | translate }} <span
            aria-hidden="true">*</span></label>
        <input id="price" class="form-control" type="number" step="0.01" formControlName="price" required
          aria-required="true" [attr.aria-invalid]="priceError()? 'true':'false'"
          [attr.aria-describedby]="priceError()? 'price-error': null" />
        @if(priceError()){<div id="price-error" class="form-error" role="alert">{{ priceError() }}</div>}
      </div>

      <div class="form-field">
        <label class="form-label" for="stock">{{ 'app.clothes.crud.form.fields.stock.label' | translate }} <span
            aria-hidden="true">*</span></label>
        <input id="stock" class="form-control" type="number" formControlName="stock" required aria-required="true"
          [attr.aria-invalid]="stockError()? 'true':'false'"
          [attr.aria-describedby]="stockError()? 'stock-error': null" />
        @if(stockError()){<div id="stock-error" class="form-error" role="alert">{{ stockError() }}</div>}
      </div>

      <div class="field-grid">
        <div class="form-field">
          <label class="form-label" for="size">{{ 'app.clothes.crud.form.fields.size.label' | translate }}</label>
          <select id="size" class="form-control" formControlName="size">
            <option value="">Select size</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
          </select>
        </div>
        <div class="form-field">
          <label class="form-label" for="season">{{ 'app.clothes.crud.form.fields.season.label' | translate }}</label>
          <select id="season" class="form-control" formControlName="season">
            <option value="">Select season</option>
            <option value="Spring">Spring</option>
            <option value="Summer">Summer</option>
            <option value="Fall">Fall</option>
            <option value="Winter">Winter</option>
          </select>
        </div>
      </div>

      <div class="field-grid">
        <div class="form-field">
          <label class="form-label" for="category">{{ 'app.clothes.crud.form.fields.category.label' | translate
            }}</label>
          <input id="category" class="form-control" type="text" formControlName="category" />
        </div>
        <div class="form-field">
          <label class="form-label" for="color">{{ 'app.clothes.crud.form.fields.color.label' | translate }}</label>
          <input id="color" class="form-control" type="text" formControlName="color" />
        </div>
      </div>

      <div class="form-field">
        <label class="form-label" for="description">{{ 'app.clothes.crud.form.fields.description.label' | translate
          }}</label>
        <textarea id="description" class="form-control" formControlName="description" rows="3"
          placeholder="Optional description"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" appButton variant="primary"
          [disabled]="itemForm.invalid || clothesStore.loading().isLoading">{{ isEditing()?
          ('app.clothes.crud.form.actions.update' | translate) : ('app.clothes.crud.form.actions.create' | translate)
          }}</button>
        <button type="button" appButton variant="secondary" (click)="resetForm()">{{
          'app.clothes.crud.form.actions.reset' | translate }}</button>
        @if(isEditing()){<button type="button" appButton variant="secondary" (click)="cancelEdit()">{{
          'app.clothes.crud.form.actions.cancel' | translate }}</button>}
      </div>
    </form>
  </section>

  <section class="stats-section" aria-label="Statistics">
    <div class="stats-grid">
      <div class="stat-card" aria-label="{{ 'app.clothes.crud.stats.total.aria' | translate }}"><span
          class="stat-label">{{ 'app.clothes.crud.stats.total.label' | translate }}</span><span class="stat-value">{{
          clothesStore.items().length }}</span></div>
      <div class="stat-card" aria-label="{{ 'app.clothes.crud.stats.available.aria' | translate }}"><span
          class="stat-label">{{ 'app.clothes.crud.stats.available.label' | translate }}</span><span
          class="stat-value">{{ clothesStore.availableItems().length }}</span></div>
      <div class="stat-card" aria-label="{{ 'app.clothes.crud.stats.lowStock.aria' | translate }}"><span
          class="stat-label">{{ 'app.clothes.crud.stats.lowStock.label' | translate }}</span><span class="stat-value">{{
          clothesStore.lowStockItems().length }}</span></div>
      <div class="stat-card" aria-label="{{ 'app.clothes.crud.stats.value.aria' | translate }}"><span
          class="stat-label">{{ 'app.clothes.crud.stats.value.label' | translate }}</span><span class="stat-value">${{
          clothesStore.totalValue().toFixed(2) }}</span></div>
    </div>
  </section>
</div>