name: Bundle Size Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build production bundle
      run: npm run build:prod
    
    - name: Analyze bundle size
      run: npm run bundle:check
    
    - name: Generate bundle report
      run: |
        echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "### Generated: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        npm run bundle:check 2>&1 || true >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload bundle analysis (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis-${{ github.sha }}
        path: |
          dist/angular-architecture/browser/
          bundle-report.json
        retention-days: 7
    
    - name: Comment PR with bundle size
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          try {
            const output = execSync('npm run bundle:check', { encoding: 'utf8' });
            const comment = `## üìä Bundle Size Analysis
            
            Bundle analysis completed successfully! 
            
            <details>
            <summary>View detailed report</summary>
            
            \`\`\`
            ${output}
            \`\`\`
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            const comment = `## ‚ùå Bundle Size Analysis Failed
            
            Bundle size check failed. Please review the changes.
            
            <details>
            <summary>View error details</summary>
            
            \`\`\`
            ${error.stdout || error.message}
            \`\`\`
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            throw error;
          }